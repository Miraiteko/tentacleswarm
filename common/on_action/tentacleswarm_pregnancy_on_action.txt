#怀孕触发
on_pregnancy_mother = { #define设置，怀孕之后280天出生，60天时知道怀孕
	on_actions = {
		tentacleswarm_on_pregnancy_pulse
	}
}
tentacleswarm_on_pregnancy_pulse = { 
	on_actions = {
		delay = { days = 5 }
		tentacleswarm_baby_corruption #主人赐福
		delay = { days = 200 }
		tentacleswarm_near_birth_pulse #接近出生时触发
	}
}
tentacleswarm_baby_corruption = {
	trigger = { 
		is_female = yes
		is_pregnant = yes
	}
	effect = {
		if = {
			limit = { is_imprisoned = yes } #被囚禁
			if = {
				limit = {
					imprisoner = {
						OR = { #囚禁者是触手宗教的
							is_tentacle_slave = yes
							has_religion = religion:tentacleswarm_religion
						}
					}
				}
				imprisoner = { save_scope_as = imprisoner }
				trigger_event = {
					id = tentacleswarm_slave.0041 #被囚禁者腐化
				}
			}
		}
		else_if = {
			limit = {
				is_ai = no #主要玩家奴隶，获得尚未赐福的flag
				OR = {
					is_tentacle_slave = yes
					has_religion = religion:tentacleswarm_religion
				}
			}
			add_character_flag = { flag = tentacle_baby_corruption_not_yet months = 10 }
		}
		else_if = {
			limit = {#主要奴隶必定被赐福
				is_ai = yes #玩家用决议
				OR = {
					is_tentacle_slave = yes
					has_religion = religion:tentacleswarm_religion
				}
				OR = {
					is_ruler = yes #或者是一位领主，可以自由地寻找机会去寻找主人
					any_spouse = { is_ruler = yes } #或者是一位领主夫人，会尽可能地找机会腐化未来的继承人
					has_trait = tentacle_slave #或者是已经公开的奴隶
				}
			}
			trigger_event = {
				id = tentacleswarm_slave.0031 #请赐
			}
		}
		else_if = {
			random_list = { #其他人，按省份腐化度得到赐福
				0 = {
					modifier = {
						add = location.county.var:tentacleswarm_corruption
						exists = location
						exists = location.county
					}
					modifier = { #已经是奴隶了，权重+20
						add = 20
						is_tentacle_slave = yes
					}
					trigger_event = {
						id = tentacleswarm_slave.0021 #水井杀
					}
				}
				100 = {
					modifier = {
						add = location.county.minus_tentacleswarm_corruption
						exists = location
						exists = location.county
					}
				}
			}
		}
	}
}
tentacleswarm_near_birth_pulse = {
	trigger = { is_pregnant = yes } #如果提前流产了的话，就不用考虑了 
	effect = {
		#天生奴遗传确认，该性状为伴X半隐性基因，男性只会是携带者。
		#FLAG说明：
		#baby_congenital_tentacle_slave：孩子为女性纯合男性携带（X+XY)
		#baby_congenital_tentacle_slave_carry：孩子为女性携带男性携带（X+xY)
		#baby_congenital_tentacle_slave_carry_low：孩子为女性携带男性正常（x+XY)
		#母亲为纯合子
		if = { 
			limit = {
				is_congenital_tentacle_slave = yes
			}
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption
				}
				#孩子一定是女性纯合
				set_pregnancy_gender = female 
				add_character_flag = { flag = baby_congenital_tentacle_slave months = 5 } 
			}
			#父亲活着，是携带者
			else_if = {
				limit = { 
					scope:real_father = { 
						is_alive = yes
						is_congenital_tentacle_slave_carry = yes
					} 
				}
				#女性一定纯合，男性一定携带
				add_character_flag = { flag = baby_congenital_tentacle_slave months = 5 }
			}
			#父亲是正常人
			else = {
				#一定携带
				add_character_flag = { flag = baby_congenital_tentacle_slave_carry months = 5 }
			}
		}
		
		#母亲为携带者
		else_if = { 
			limit = {
				is_congenital_tentacle_slave_carry = yes
			}
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption
				}
				random_list = {
					50 = {#女性纯合
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slave months = 5 }
					}
					50 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slave_carry months = 5 }
					}
				}
			}
			#父亲是携带者
			else_if = {
				limit = { 
					scope:real_father = { is_congenital_tentacle_slave_carry = yes } 
				}
				random_list = {
					50 = {#女性纯合，男性携带
						add_character_flag = { flag = baby_congenital_tentacle_slave months = 5 }
					}
					50 = {#女性携带，男性正常
						add_character_flag = { flag = baby_congenital_tentacle_slave_carry_low months = 5 }
					}
				}
			}
			#父亲是正常人
			else = {
				random_list = {
					50 = {#携带
						add_character_flag = { flag = baby_congenital_tentacle_slave_carry months = 5 }
					}
					50 = {#正常
					}
				}
			}
		}
		#母亲为正常人
		else = { 
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption 
				}
				#孩子一定是女性携带
				set_pregnancy_gender = female
				add_character_flag = { flag = baby_congenital_tentacle_slave_carry months = 5 } 
			}
			#父亲是携带者
			else_if = {
				limit = { 
					scope:real_father = { is_congenital_tentacle_slave_carry = yes } 
				}
				#女性携带，男性正常
				add_character_flag = { flag = baby_congenital_tentacle_slave_carry_low months = 5 }
			}
			#父亲是正常人
			else = {
				#孩子正常
			}
		}
	}
}


#出生触发
on_birth_child = {
	on_actions = {
		tentacleswarm_birth_pulse
	}
}
#TS出生结算
tentacleswarm_birth_pulse = {
	effect = {
		#新生儿天生奴遗传结算
		if = { #X+XY,女性纯合，男性携带
			limit = {
				mother = { has_character_flag = baby_congenital_tentacle_slave } 
			}
			if = {
				limit = {
					is_female = yes
				}
				become_congenital_tentacle_slave = yes
			}
			else = {
				become_congenital_tentacle_slave_carry = yes
			}
		}	
		else_if = { #X+xY，都是携带
			limit = {
				mother = { has_character_flag = baby_congenital_tentacle_slave_carry } 
			}
			become_congenital_tentacle_slave_carry = yes
		}	
		if = { #x+XY，女性携带，男性正常
			limit = {
				mother = { has_character_flag = baby_congenital_tentacle_slave_carry_low } 
			}
			if = {
				limit = {
					is_female = yes
				}
				become_congenital_tentacle_slave_carry = yes
			}
			else = {
			}
		}	
		else = { #正常人
		}
		#母亲移除赐福
		mother = {
			if = {
				limit = { has_character_flag = tentacle_baby_corruption }
				remove_character_flag = tentacle_baby_corruption
			}
			if = {
				limit = { has_character_flag = tentacle_baby_corruption_not_yet }
				remove_character_flag = tentacle_baby_corruption_not_yet
			}
		}		
	}
}
#接近成年
on_15th_birthday = {
	on_actions = {
		tentacleswarm_adult_pulse
	}
}
tentacleswarm_adult_pulse = {
	effect = {
		if = { #天生奴隶成年时成为奴隶
			limit = {
				is_female = yes
				is_congenital_tentacle_slave = yes 
			}
			trigger_event = {
				id = tentacleswarm_slave.0001 #天生腐化
			}
		}
		else_if = {
			limit = {
				is_female = yes#被触手宗教囚禁的
				exists = imprisoner 
				imprisoner = {
					OR = { 
						is_tentacle_slave = yes
						has_religion = religion:tentacleswarm_religion
					}
				}
			}
			trigger_event = {
				id = tentacleswarm_slave.0041 #被监禁者腐化
			}
		}
		else_if = { #其他女性看成年所在地的腐化度
			limit = { is_female = yes }
			random_list = {
				0 = {
					modifier = { #监护人是奴隶，权重+500
						add = 500
						any_relation = {
							type = guardian
							is_tentacle_slave = yes
						}
					}
					random_relation = {
						type = guardian
						limit = { is_tentacle_slave = yes }
						save_scope_as = guardian
					}
					trigger_event = {
						id = tentacleswarm_slave.0011 #监护人
					}
				}
				0 = {
					modifier = {
						add = location.county.var:tentacleswarm_corruption
						exists = location
						exists = location.county
					}
					trigger_event = {
						id = tentacleswarm_slave.0021 #水井杀
					}
				}
				100 = {
					modifier = {
						add = location.county.minus_tentacleswarm_corruption
						exists = location
						exists = location.county
					}
				}
			}
		}
	}
}