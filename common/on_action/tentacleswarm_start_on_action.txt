#开局设置
on_game_start_after_lobby = {
	on_actions = { 
		tentacleswarm_on_game_start
	}
}
tentacleswarm_on_game_start = {
	effect = {
		#成就初始化
		tentacleswarm_set = yes
		
		#所有默认宗教，敌对触手
		every_religion_global = {
			every_faith = {
				if = {
					limit = {
						not = { has_doctrine = doctrine_tentacle_slave_worship }
					}
					add_doctrine = doctrine_tentacle_slave_evil
				}
			}
		}
		#初始奴隶生成，
		set_global_variable = { name = start_tentacle_slave_count value = 0 }
		random_ruler = {
			trigger_event = {
				id = tentacleswarm_speaker.0003 #生成speaker
				days = 5
			}
		}
		every_living_character = { #15%的人带有触手血脉
			if = {
				random_list = {
					85 = {
					}
					15 = {
						become_congenital_tentacle_slave_carry = yes
					}
				}
			}
		}
		
		#测试，上携带者flag
		every_living_character = {
			if = {
				limit = { 
					always = no
					is_tentaclable_female = yes 
				}
				#become_congenital_tentacle_slave = yes
				#become_congenital_tentacle_slave_carry = yes
				become_tentacle_slave = yes#成为奴隶，测试
			}
		}
		
		#所有伯爵领，初始化腐化度
		every_county = {
			#初始化
			set_variable =  { name = tentacleswarm_corruption value = 0 }
			set_variable =  { name = tentacleswarm_corruption_decay value = 30 }	
			if = {
				limit = { has_game_rule = tentacleswarm_start_corruption_medium }
				change_variable =  { name = tentacleswarm_corruption add = 30 }
			}
			else_if = {
				limit = { has_game_rule = tentacleswarm_start_corruption_major }
				change_variable =  { name = tentacleswarm_corruption add = 120 }
			}
			#初始化自然生长
			set_variable =  { name = tentacleswarm_corruption_nature value = 0 }
			if = {
				limit = { is_coastal_county = yes} #伯爵领靠海
				change_variable =  { name = tentacleswarm_corruption_nature add = 0.5 }
			}
			every_county_province = { 
				if = { #每块湿地
					limit = { terrain = wetlands }
					prev = { change_variable =  { name = tentacleswarm_corruption_nature add = 1 } }
				}
			}
		}
		
		#腐化纹章初始化
		#每个有地头衔，备份一下纹章
		#男爵领玩家不关注，备份不备份无所谓
		if = {
			limit = { has_game_rule = tentacleswarm_corrupt_dynamic_coa_rule } #纹章动态腐化规则开启
			every_empire = {
				tentacleswarm_title_coa_check = yes
			}
			every_kingdom = {
				tentacleswarm_title_coa_check = yes
			}
			every_duchy = {
				tentacleswarm_title_coa_check = yes
			}
			every_county = {
				tentacleswarm_title_coa_check = yes
			}
		}
		
		#最后触发一下年度全局事件避免bug
		trigger_event = {
			on_action = tentacleswarm_yearly_global_pulse
		}
	}
}
#有人建新宗教的时候，一并初始化
on_faith_created = {
	on_actions = { 
		tentacleswarm_on_faith_created
	}
}
tentacleswarm_on_faith_created = {
	effect = {
	}
}
on_death = {
	on_actions = { 
		tentacleswarm_on_death
	}
}
tentacleswarm_on_death = {
	effect = {
		if = { #speaker死亡的话，重新生成一位
			limit = { has_character_flag = tentacle_speaker_character }
			random_ruler = {
				trigger_event = {
					id = tentacleswarm_speaker.0003 #生成speaker
					days = 5
				}
			} 
		}
	}
}
