#怀孕触发
on_pregnancy_mother = { #define设置，怀孕之后280天出生，60天时知道怀孕
	on_actions = {
		tentacleswarm_on_pregnancy_pulse
	}
}
tentacleswarm_on_pregnancy_pulse = { 
	on_actions = {
		tentacleswarm_baby_corruption #主人赐福
		delay = { days = 200 }
		tentacleswarm_near_birth_pulse #接近出生时触发
	}
}
tentacleswarm_baby_corruption = {
	trigger = { #目前只考虑奴隶被赐福
		is_tentacle_slavery = yes
		is_imprisoned = no #不能被囚禁
		OR = {
			is_ruler = yes #或者是一位领主，可以自由地寻找机会去寻找主人
			any_spouse = { is_ruler = yes } #或者是一位领主夫人，会尽可能地找机会腐化未来的继承人
			has_trait = tentacle_slavery #或者是已经公开的奴隶
		}
	}
	effect = {
		add_character_flag = { flag = tentacle_baby_corruption months = 10 } 
	}
}
tentacleswarm_near_birth_pulse = {
	trigger = { is_pregnant = yes } #如果提前流产了的话，就不用考虑了 
	effect = {
		#天生奴遗传确认，该性状为伴X隐形基因，雄性不表现
		
		#母亲为纯合子
		if = { 
			limit = {
				has_character_flag = congenital_tentacle_slavery
			}
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption
				}
				#孩子一定是女性纯合
				set_pregnancy_gender = female 
				add_character_flag = { flag = baby_congenital_tentacle_slavery months = 5 } 
			}
			#父亲活着，是携带者
			else_if = {
				limit = { 
					scope:real_father = { 
						is_alive = yes
						has_character_flag = congenital_tentacle_slavery_carry
					} 
				}
				random_list = {
					50 = {#女性纯合
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery months = 5 }
					}
					50 = {#男性携带
						set_pregnancy_gender = male
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
				}
			}
			#父亲是正常人
			else = {
				random_list = {
					50 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					50 = {#男性携带
						set_pregnancy_gender = male
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
				}
			}
		}
		
		#母亲为携带者
		else_if = { 
			limit = {
				has_character_flag = congenital_tentacle_slavery_carry
			}
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption
				}
				random_list = {
					50 = {#女性纯合
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery months = 5 }
					}
					50 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
				}
			}
			#父亲是携带者
			else_if = {
				limit = { 
					scope:real_father = { has_character_flag = congenital_tentacle_slavery_carry } 
				}
				random_list = {
					25 = {#女性纯合
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery months = 5 }
					}
					25 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					25 = {#男性携带
						set_pregnancy_gender = male
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					25 = {#男性正常
						set_pregnancy_gender = male
					}
				}
			}
			#父亲是正常人
			else = {
				random_list = {
					25 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					25 = {#女性正常
						set_pregnancy_gender = female
					}
					25 = {#男性携带
						set_pregnancy_gender = male
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					25 = {#男性正常
						set_pregnancy_gender = male
					}
				}
			}
		}
		#母亲为正常人
		else = { 
			#母亲被赐福
			if = { 
				limit = { 
					has_character_flag = tentacle_baby_corruption 
				}
				#孩子一定是女性携带
				set_pregnancy_gender = female 
				add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 } 
			}
			#父亲是携带者
			else_if = {
				limit = { 
					scope:real_father = { has_character_flag = congenital_tentacle_slavery_carry } 
				}
				random_list = {
					50 = {#女性携带
						set_pregnancy_gender = female
						add_character_flag = { flag = baby_congenital_tentacle_slavery_carry months = 5 }
					}
					50 = {#男性正常
						set_pregnancy_gender = male
					}
				}
			}
			#父亲是正常人
			else = {
				#孩子正常
			}
		}
	}
}


#出生触发
on_birth_child = {
	on_actions = {
		tentacleswarm_birth_pulse
	}
}
#TS出生结算
tentacleswarm_birth_pulse = {
	effect = {
		#新生儿天生奴遗传结算
		if = { #天生奴隶
			limit = {
				is_female = yes
				mother = { has_character_flag = baby_congenital_tentacle_slavery } 
			}
			add_character_flag = congenital_tentacle_slavery #成为纯合子
			add_trait = congenital_tentacle_slavery #成为奴隶，测试
			become_tentacle_slavery = yes
		}
		else_if = { #有的时候有bug让男孩成为纯合子，改为成为携带者
			limit = {
				is_female = no
				mother = { has_character_flag = baby_congenital_tentacle_slavery } 
			}
			add_character_flag = congenital_tentacle_slavery_carry #成为携带者
			add_trait = congenital_tentacle_slavery_carry #成为奴隶，测试
		}	
		else_if = { #携带者
			limit = {
				mother = { has_character_flag = baby_congenital_tentacle_slavery_carry } 
			}
			add_character_flag = congenital_tentacle_slavery_carry #成为携带者
			add_trait = congenital_tentacle_slavery_carry #成为奴隶，测试
		}	
		else = { #正常人
			#add_trait = congenital_tentacle_slavery_no #成为奴隶，测试
		}
	}
}
#年度触发
random_yearly_everyone_pulse = {
	on_actions = { 
		tentacleswarm_bliever_yearly
		tentacle_slavery_yearly
	}
}
tentacleswarm_bliever_yearly = { #触手信徒年度触发
	trigger = {
		has_religion = religion:tentacleswarm_religion
	}
	effect = {
		if = {
			limit = {
				is_female = yes
				not = { has_trait = tentacle_slavery } #没有成为奴隶的女性成为奴隶
			}
			add_trait = tentacle_slavery
		}
	}
}
tentacle_slavery_yearly = {
	trigger = {
		is_tentacle_slavery = yes
	}
	effect = {
		add_character_flag = ____TENTACLE_SLAVERY____
		if = {
			limit = {
				#如果上头有人，皈依正统信仰,揭露身份
				OR = {
					is_ruler = yes
					any_liege_or_above = { has_trait = tentacle_slavery }
				}
			}
			if = {
				limit = {
					not = { has_religion = religion:tentacleswarm_religion }
				}
				if = { 
					limit = { #如果你控制了旧的信仰领袖头衔，摧毁它
						exists = faith.religious_head
						faith.religious_head = this
					}
					destroy_title =  faith.religious_head_title
					faith = { change_fervor = -100 }
				}
				set_character_faith = faith:tentacleswarm_slavery
				add_trait = tentacle_slavery
			}
		}
		else = {
			#如果上头没人，跟风当地信仰
			if = {
				limit = {
					has_religion = religion:tentacleswarm_religion 
				}
				set_character_faith = location.faith
			}
			#根据新信仰选择是否要将身份藏起来
			if = {
				limit = { has_trait = tentacle_slavery } 
				remove_trait = tentacle_slavery
				become_tentacle_slavery = yes
			}
		}
		if = {
			limit = {
				any_spouse = {
					holds_landed_title = yes #配偶有地，尝试密谋夺取
				}
				Not = { 
					any_scheme = {
						is_hostile = yes
					}
				}
			}
			random_spouse = {
				limit = { holds_landed_title = yes }
				save_scope_as = target
			}
			start_scheme = {
				type = tentacle_slavery_claim_throne
				target = scope:target
			}
		}
	}
}
#死亡触发
on_death = {
	on_actions = { 
	}
}

#开局设置
on_game_start_after_lobby = {
	on_actions = { 
		tentacleswarm_on_game_start
	}
}
tentacleswarm_on_game_start = {
	effect = {
		#所有默认宗教，敌对触手
		every_religion_global = {
			every_faith = {
				if = {
					limit = {
						not = { has_doctrine = doctrine_tentacleswarm_accepted }
					}
					add_doctrine = doctrine_tentacleswarm_evil
				}
			}
		}
		#测试，给所有人上携带者flag
		every_living_character = {
			if = {
				limit = { is_female = yes }
				become_tentacle_slavery = yes
			}
			add_character_flag = congenital_tentacle_slavery_carry #成为携带者
			add_trait = congenital_tentacle_slavery_carry #成为奴隶，测试
		}
		#所有伯爵领，初始化腐化度
		every_county = {
			#测试
			set_variable =  { name = tentacleswarm_corruption value = 0 }
			
			if = {
				limit = { religion = religion:christianity_religion }
				set_variable =  { name = tentacleswarm_corruption value = 20 }
			}
			else_if ={
				limit = { religion = religion:islam_religion }
				set_variable =  { name = tentacleswarm_corruption value = 40 }
			}
			else_if ={
				limit = { religion = religion:hinduism_religion }
				set_variable =  { name = tentacleswarm_corruption value = 60 }
			}
			else_if ={
				limit = { religion = religion:buddhism_religion }
				set_variable =  { name = tentacleswarm_corruption value = 80 }
			}
			else_if ={
				limit = { religion = religion:tengrism_religion }
				set_variable =  { name = tentacleswarm_corruption value = 100 }
			}
		}
	}
}
