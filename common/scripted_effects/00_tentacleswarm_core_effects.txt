#获得触手奴隶秘密/如果是触手宗教的话，直接暴露
become_tentacle_slave = {
	if = {
		limit = { #不是触手奴隶
			is_tentacle_slave = no
			is_female = yes
		}
		if = {
			limit = { 
				debug_only = yes #测试用
			}
			add_trait = tentacle_slave_even_hide
		}
		if = {
			#如果触手是忌讳或者罪恶的话，获得秘密
			limit = {
				OR = {
					secret_tentacle_slave_is_shunned_trigger = yes
					secret_tentacle_slave_is_criminal_trigger = yes
					secret_tentacle_slave_is_evil_trigger = yes
				}
			}
			add_secret = {
				type = secret_tentacle_slave
			}
		}
		#否则直接拿特质
		else = {
			add_trait = tentacle_slave
		}
		add_character_flag = immune_to_disease #有主人赐福之后不会生病
		add_character_flag = tentacle_slave #添加flag，用于判断检测
	}	
}
#被触手腐化
tentacle_corrupt = {
	if = {
		limit = {
			is_pregnant = yes #怀孕了但没有被赐福的话，被赐福
			NOT = { has_character_flag = tentacle_baby_corruption }
		}
		add_character_flag = { flag = tentacle_baby_corruption months = 10 } 
	}
	if = {
		limit = {
			is_pregnant = yes #如果作为玩家有未被赐福的flag，移除该flag
			has_character_flag = tentacle_baby_corruption_not_yet
		}
		remove_character_flag = tentacle_baby_corruption_not_yet
	}
	if = {
		#尚未一阶段腐化，进行腐化
		limit = {
			NOT = { has_trait = tentacle_womb_corrupt }
		}
		trigger_event = {
			id = tentacleswarm_slave.2001
			days = 7
		}
	}
	else_if = {
		#如果已经一阶段腐化，则必然被赐福
		limit = {
			is_pregnant = no
		}
		create_character = {
			name = "TENTACLE_LORD"
			location = root.capital_province
			template = default_tentacle_monster_character
			save_scope_as = tentacle_monster
			dynasty = none
		}
		make_pregnant = {
			father = scope:tentacle_monster
		}
		scope:tentacle_monster = {
			set_sexuality = heterosexual
			death = { death_reason = death_disappearance }
		}
		add_character_flag = { flag = tentacle_baby_corruption months = 10 } 
	}
}

#皈依触手信仰
convert_to_tentacleswarm_religion = {	
	save_scope_as = character
	if	= {
		limit = {
			not = { has_religion = religion:tentacleswarm_religion }
		}
		faith = { save_scope_as = faith }
		if = { 
			limit = { #如果你控制了旧的信仰领袖头衔，摧毁它
				exists = faith.religious_head
				faith.religious_head = this
			}
			destroy_title =  faith.religious_head_title
			faith = { change_fervor = -100 }
		}
		if = { #贞洁者变成堕邪者
			limit = { 
				has_nickname = nick_the_chaste
				has_trait = saint
			}
			remove_nickname = yes
			give_nickname = nick_the_depraved
			faith = { change_fervor = -100 }
			custom_tooltip = convert_to_tentacleswarm_depraved.tt
			hidden_effect = {
				every_living_character = {
					limit = {
						faith = root.faith
						is_female = yes
						NOT = { this = root }
					}
					trigger_event = {
						on_action = convert_to_tentacleswarm_religion_pulse
						days = { 1 30 }
					}
				}
			}
		}
		#改信
		set_character_faith = faith:tentacleswarm_slavery
		#第一次出现改信的时候，给玩家弹事件
		tentacleswarm_appear_effect_4 = yes
	}
	if = { #不是奴隶的女性成年成为奴隶
		limit = { 
			is_adult = yes
			is_female = yes
			is_tentacle_slave = no
		}
		trigger_event = {
			id = tentacleswarm_slave.0031 #虔诚赐福
		}
	}
	if = { #未公开的奴隶进行公开
		limit = { 
			is_hidden_tentacle_slave = yes
		}
		add_trait = tentacle_slave
	}
}

#4VA：4-乙烯基苯甲醚——来源，奴隶领主揭露身份，奴隶夫人夺权成功，奴隶领主战争胜利
tentacleswarm_4VA = {
	custom_tooltip = tentacle_courtier_and_vassal_4VA_tooltip

	hidden_effect = {
		#廷臣皈依
		every_courtier_or_guest	= {
			limit = {
				is_tentacle_slave = yes
			}
			convert_to_tentacleswarm_religion = yes
		}
		#封臣皈依
		every_vassal_or_below ={
			if = {
				limit = { is_tentacle_slave = yes } 
				convert_to_tentacleswarm_religion = yes
			}
			every_courtier_or_guest	= {
				limit = {
					is_tentacle_slave = yes
				}
				convert_to_tentacleswarm_religion = yes
			}
		}
	}

	
	if ={
		limit = { 
			debug_only = yes 
			is_landed = yes
			highest_held_title_tier >= tier_county
			capital_county = {
				NOT =  { has_county_modifier = tentacleswarm_destroy }
			}
		}
		capital_province = { barony = {set_color_from_title = title:d_tentacleswarm_4VA } }#改颜色
	}
	#释放费洛蒙给周围领主
	save_scope_as = 4VA_from 
	custom_tooltip = tentacle_neighboring_4VA_tooltip
	hidden_effect = {
		#周围领主
		every_character_to_title_neighboring_and_across_water_county = {
			limit = {
				NOT =  { has_county_modifier = tentacleswarm_destroy }
			}
			holder = {
				trigger_event = {
					on_action = tentacleswarm_4VA_pulse
					days = { 10 60 }
				}
			}
		}
		#上级领主
		every_liege_or_above = {
			limit = {
				is_landed = yes
				highest_held_title_tier >=tier_county
				capital_county = {
					NOT =  { has_county_modifier = tentacleswarm_destroy }
				}
			}
			trigger_event = {
				on_action = tentacleswarm_4VA_pulse
				days = { 10 60 }
			}
		}
		#封臣
		every_vassal_or_below = {
			limit = {
				is_landed = yes
				highest_held_title_tier >=tier_county
				capital_county = {
					NOT =  { has_county_modifier = tentacleswarm_destroy }
				}
			}
			trigger_event = {
				on_action = tentacleswarm_4VA_pulse
				days = { 10 60 }
			}
		}
		#战争对象
		every_war_enemy = {
			limit = {
				is_landed = yes
				highest_held_title_tier >=tier_county
				capital_county = {
					NOT =  { has_county_modifier = tentacleswarm_destroy }
				}
			}
			trigger_event = {
				on_action = tentacleswarm_4VA_pulse
				days = { 10 60 }
			}
		}
	}
}

#遗传结算
become_congenital_tentacle_slave = { #成为天生奴隶
	#成为纯合子
	add_character_flag = congenital_tentacle_slave
	#测试用标记
	if = {
		limit = { 
			debug_only = yes 
		}
		add_trait = congenital_tentacle_slave
	}
	#当然也是携带者
	become_congenital_tentacle_slave_carry = yes
	#15岁以上成为奴隶
	if ={
		limit = { 
			age >= 15
		}
		become_tentacle_slave = yes
	}
	#受到祝福
	random_list = {
		85 = { change_trait_rank = { trait = beauty_good rank = 1 max = 3 } }
		10 = { add_trait = fecund }
		5 = { add_trait = albino }
	}
}
become_congenital_tentacle_slave_carry = { #成为天生奴隶基因携带者
	add_character_flag = congenital_tentacle_slave_carry
	#受到祝福
	if = {
		limit = { has_trait = beauty_bad }
		change_trait_rank = { trait = beauty_bad rank = -3 max = 3 }
	}
}